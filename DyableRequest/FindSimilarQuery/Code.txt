var excerpt_id = 0;
var prev_target = -1;
var excerpt_select = "";
var curr_scroll = 0;

for(i=0; i<Math.min(5, doc_set.length); i++) {
    loadXMLDoc(doc_set[excerpt_id], node_set[excerpt_id], excerpt_id, query_text, focus_text, word_id_set[excerpt_id]);
    excerpt_id++;
}


window.onscroll = scroll;
function scroll() {
    if(window.pageYOffset >= curr_scroll && excerpt_id<doc_set.length) {
        loadXMLDoc(doc_set[excerpt_id], node_set[excerpt_id], excerpt_id, query_text, focus_text, word_id_set[excerpt_id]);
        excerpt_id++;
    }
    
    curr_scroll = Math.max(curr_scroll, window.pageYOffset);
}

// this is simply a shortcut for the eyes and fingers
function $(id)
{
	return document.getElementById(id);
}

var _startX = 0;			// mouse starting positions
var _startY = 0;
var _offsetX = 0;			// current element offset
var _offsetY = 0;
var _dragElement;			// needs to be passed from OnMouseDown to OnMouseMove
var _oldZIndex = 0;			// we temporarily increase the z-index during drag


InitDragDrop();

function InitDragDrop()
{
	document.onmousedown = OnMouseDown;
	document.onmouseup = OnMouseUp;
	document.onmouseover = OnMouseOver;
        document.onmouseout = OnMouseOut;
}


function OnMouseDown(e)
{
	// IE is retarded and doesn't pass the event object
	if (e == null) 
		e = window.event; 
	
	// IE uses srcElement, others use target
	var target = e.target != null ? e.target : e.srcElement;
	
	/*_debug.innerHTML = target.className == 'drag' 
		? 'draggable element clicked' 
		: 'NON-draggable element clicked';*/
		
    if(target.id == "backdrop" && excerpt_select.length > 0) {
        document.getElementById("block_excerpt").style.display="none";
        document.getElementById("backdrop").style.display="none";
        document.getElementById("backdrop").style.height=screen.availHeight;
        document.getElementById("container").style.display="block";
        window.scrollTo(0, curr_scroll);
        excerpt_select = "";
    }
		
	if(target.className == 'sum') {
        excerpt_select = target.id.toString();
        var tag = target.id.toString();
        tag = "excerpt" + target.id.toString().substring(7, tag.length);
        var height = Math.max(window.innerHeight, window.scrollHeight);
        target.style.borderWidth = "3px";
        
        
        document.getElementById("block_excerpt").innerHTML = 
        "<font size=\"0\">" + document.getElementById(tag).innerHTML + "</font>";
        document.getElementById("block_excerpt").style.display="block";
        document.getElementById("backdrop").style.display="block";
        document.getElementById("backdrop").style.height=height;
        document.getElementById("container").style.display="none";
        
        document.getElementById("block_excerpt").style.left = target.style.left;
        document.getElementById("block_excerpt").style.top = 20;
        
        window.scrollTo(0, 0);
	} 

	// for IE, left click == 1
	// for Firefox, left click == 0
	if ((e.button == 1 && window.event != null || 
		e.button == 0) && 
		target.className == 'drag')
	{
		// grab the mouse position
		_startX = e.clientX;
		_startY = e.clientY;
		
		// grab the clicked element's position
		_offsetX = ExtractNumber(target.style.left);
		_offsetY = ExtractNumber(target.style.top);
		
		// bring the clicked element to the front while it is being dragged
		_oldZIndex = target.style.zIndex;
		target.style.zIndex = 10000;
		
		// we need to access the element in OnMouseMove
		_dragElement = target;

		// tell our code to start moving the element with the mouse
		document.onmousemove = OnMouseMove;
		
		// cancel out any text selections
		document.body.focus();
		
		// prevent text selection in IE
		document.onselectstart = function () { return false; };
		// prevent IE from trying to drag an image
		target.ondragstart = function() { return false; };
		
		// prevent text selection (except IE)
		return false;
	}
}

function ExtractNumber(value)
{
	var n = parseInt(value);
	
	return n == null || isNaN(n) ? 0 : n;
}

function OnMouseMove(e)
{
    
	if (e == null) 
		var e = window.event; 

	// this is the actual "drag code"
	_dragElement.style.left = (_offsetX + e.clientX - _startX) + 'px';
	_dragElement.style.top = (_offsetY + e.clientY - _startY) + 'px';
	
//	_debug.innerHTML = '(' + _dragElement.style.left + ', ' + _dragElement.style.top + ')';	
}

function OnMouseOut(e) {
}

function OnMouseOver(e)
{
}

function OnMouseUp(e)
{
	if (_dragElement != null)
	{

		// we're done with these events until the next OnMouseDown
		document.onmousemove = null;
		document.onselectstart = null;
		_dragElement.ondragstart = null;

		// this is how we know we're not dragging
		_dragElement = null;
		
		//_debug.innerHTML = 'mouse up';
	}
}
